<span  style="font-family: Simsun,serif; font-size: 17px; ">

- [多线程上下文切换](https://www.jianshu.com/p/19fc8aca712c)

[TOC]

###  一. CPU时间片

- CPU时间片即CPU分配给每个线程的执行时间段，称作它的时间片。CPU时间片一般为几十毫秒(ms)


### 二. 什么是上下文切换

- CPU通过时间片段的算法来循环执行线程任务，而循环执行即每个线程允许运行的时间后的切换，
- 而这种循环的切换使各个程序从表面上看是同时进行的。而切换时会保存之前的线程任务状态，
- 当切换到该线程任务的时候，会重新加载该线程的任务状态。而这个从保存到加载的过程称之为上下文切换。
1. 若当前线程还在运行而时间片结束后，CPU将被剥夺并分配给另一个线程。
2. 若线程在时间片结束前阻塞或结束，CPU进行线程切换。而不会造成CPU资源浪费。

### 三. 上下文切换造成的影响

- 参考代码
~~~
ThreadContext
~~~
- 结果是次数少的话，串联的速度快，是因为上下文切换导致额外的开销

### 四. 如何减少上下文切换导致额外的开销

- 减少上下文切换次数便可以提高多线程的运行效率。
- 减少上下文切换的方法有无锁并发编程、CAS算法、避免创建过多的线程和使用协程。
1. 无锁并发编程.
2. CAS算法。Java提供了一套原子性操作的数据类型（java.util.concurrent.atomic包下），使用CAS算法来更新数据，不需要加锁。如:AtomicInteger、AtomicLong等。
3. 避免创建过多的线程。如任务量少时，尽可能减少创建线程。对于某个时间段任务量很大的这种情况，我们可以通过线程池来管理线程的数量，避免创建过多线程。
4. 协程：即协作式程序，其思想是，一系列互相依赖的协程间依次使用CPU，每次只有一个协程工作，而其他协程处于休眠状态。如：JAVA中使用wait和notify来达到线程之间的协同工作。

</span>