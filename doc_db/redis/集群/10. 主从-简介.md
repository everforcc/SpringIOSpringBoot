<font face="Simsun" size=3>

[TOC]

### 1. 架构图

~~~
           master
    slave           slave
slave slave      slave slave
~~~

### 2. 复制原理

- 复制分为两部分操作 同步SYNC和命令传播

#### 2.1 同步SYNC

1. 从服务器发送 SYNC
2. 主服务器接收 SYNC
3. 主服务器生成 RDB
4. 主服务器发送 RDB 给 从
5. 从服务器接收 RDB 并恢复数据

#### 2.2 命令传播

1. 主服务器数据被修改,主从不一致
2. 缓存命令
3. 将命令发送给从服务器
4. 从收到命令执行
5. 主从一致

### 2.3 为什么需要两步

1. 主服务器在生成RDB快照的时候，仍然会收到客户端的命令修改数据
2. 生成RDB的时候缓存命令
3. 发送RDB后再发送缓存命令
4. 才能达到一致

### 3. 流程

| 时间  | 主服务器                                                                        | 从服务器                               |
|-----|-----------------------------------------------------------------------------|------------------------------------|
| 0   | 启动                                                                          | 启动                                 |
| 1   | set k1 v1                                                                   | /                                  |
| 2   | set k2 v2                                                                   | /                                  |
| 3   | set k3 v3                                                                   | /                                  |
| 4   | /                                                                           | 向主服务器发送SYNC命令                      |
| 5   | 接受到从服务器发来的SYNC命令,执行 BGSAVE 命令,生成包含k1,k2,k3 的RDB 文件<br/> 并使用缓冲区记录接下来执行的所有写命令 | /                                  |
| 6   | set k4 v4 ,并保存到缓冲区                                                          | /                                  |
| 7   | set k5 v5 ,并保存到缓冲区                                                          | /                                  |
| 8   | BGSAVE 命令执行完毕,向服务器发送RDB文件                                                   | /                                  |
| 9   | /                                                                           | 接收并载入主服务器发来的RDB文件,获得K1,K2,K3 三个键   |
| 10  | 向从服务器发送缓冲区保存的写命令 set k4 v5 ,set k5 v5                                       | /                                  |
| 11  | /                                                                           | 接收并执行主服务器发来的两个 set 命令,得到 k4,k5 两个键 |
| 12  | 同步完成,主从都有 k12345                                                            | 同步完成,主从都有 k12345                   |

### 4. 优缺点

#### 4.1 优点

1. 读写分离 提高了可用性
2. 解决了单机故障
3. 复制期间master和slave都是非阻塞方式仍然可用

#### 4.2 缺点

1. master宕机期间需要手动切换主机,部分数据不能及时同步从服务器,造成数据不一致,需要人手工解决
2. slave宕机后,多个slave恢复,大量SYNC同步会造成masterIO压力倍增,可以分开启动

### 4.3 结论

- 主从复制,提高了可用性

</font>